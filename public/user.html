<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>User's page</title>
    <script>
        const logout_url = "http://localhost:3000/logout";
        const get_login_url = "http://localhost:3000/get_login";
        const unsolved_url = "http://localhost:3000/user/unsolved";
        const solved_url = "http://localhost:3000/user/solved";
        const put_url = "http://localhost:3000/user/put_problem";

        function reqListenerUnsolved() {
            let data = JSON.parse(this.responseText);
            let table = document.getElementById("unsolved-table");
            table.innerHTML='';
            if (data.length > 0) {
                let hrow = table.insertRow();
                let titleCell = hrow.insertCell();
                titleCell.outerHTML = '<th>Title</th>';

                let descriptionCell = hrow.insertCell();
                descriptionCell.outerHTML = '<th>Description</th>';

                let placeholder = document.getElementById("unsolved-placeholder");
                placeholder.innerHTML = "";
            } else {
                let placeholder = document.getElementById("unsolved-placeholder");
                placeholder.innerHTML = "No unsolved problems to show";
            }
            for (let i = 0; i < data.length; i++) {
                let newRow = table.insertRow();
                let titleCell = newRow.insertCell();
                titleCell.innerHTML = data[i]['title'];

                let descriptionCell = newRow.insertCell();
                descriptionCell.innerHTML = "<pre style='font-family: sans-serif; margin: 0'>" + data[i]['description'] + "</pre>";
            }
        }

        function reqListenerSolved() {
            let data = JSON.parse(this.responseText);
            let table = document.getElementById("solved-table");
            table.innerHTML='';
            if (data.length > 0) {
                let hrow = table.insertRow();
                let titleCell = hrow.insertCell();
                titleCell.outerHTML = '<th>Title</th>';

                let descriptionCell = hrow.insertCell();
                descriptionCell.outerHTML = '<th>Description</th>';

                let noteCell = hrow.insertCell();
                noteCell.outerHTML = '<th>Tech support note</th>';

                let placeholder = document.getElementById("solved-placeholder");
                placeholder.innerHTML = "";
            } else {
                let placeholder = document.getElementById("solved-placeholder");
                placeholder.innerHTML = "No solved problems to show";
            }
            for (let i = 0; i < data.length; i++) {
                let newRow = table.insertRow();
                let titleCell = newRow.insertCell();
                titleCell.innerHTML = data[i]['title'];

                let descriptionCell = newRow.insertCell();
                descriptionCell.innerHTML = "<pre style='font-family: sans-serif; margin: 0'>" + data[i]['description'] + "</pre>";

                let noteCell = newRow.insertCell();
                noteCell.innerHTML = "<pre style='font-family: sans-serif; margin: 0'>" + data[i]['note'] + "</pre>";
            }
        }

        function queryTable(request, reqListener) {
            let oReq = new XMLHttpRequest();
            oReq.addEventListener('load', reqListener);
            oReq.open("GET", request);
            oReq.send();
        }

        function queryTables() {
            queryTable(unsolved_url, reqListenerUnsolved);
            queryTable(solved_url, reqListenerSolved);
        }

        function setUsername(request) {
            console.log(request);

            function reqListenerUsername() {
                let data = JSON.parse(this.responseText);
                let username_span = document.getElementById("username");
                username_span.innerHTML = data['login'];
            }

            let oReq = new XMLHttpRequest();
            oReq.addEventListener('load', reqListenerUsername);
            oReq.open("GET", request);
            oReq.send();
        }

        function submitProblem(request) {
            let title = document.getElementById("problem-title").value;
            let description = document.getElementById("problem-description").value;
            if (title == '') {
                let error_container = document.getElementById("error-container");
                error_container.innerHTML = "Problem title cannot be empty";
                return;
            } else if (description == '') {
                let error_container = document.getElementById("error-container");
                error_container.innerHTML = "Problem description cannot be empty";
                return;
            } else {
                let error_container = document.getElementById("error-container");
                error_container.innerHTML = "";
            }
            let oReq = new XMLHttpRequest();

            oReq.addEventListener('load', queryTables); 
            oReq.open("PUT", request);
            oReq.setRequestHeader('Content-Type', 'application/json'); 
            oReq.send(JSON.stringify({ title : document.getElementById("problem-title").value, description: document.getElementById("problem-description").value }));
            document.getElementById("problem-title").value = '';
            document.getElementById("problem-description").value = '';
        }

        document.addEventListener("DOMContentLoaded", queryTables);
        document.addEventListener("DOMContentLoaded", function() {setUsername(get_login_url)});
        
        function logout(request) {
            let oReq = new XMLHttpRequest();
            oReq.open("GET", request);
            oReq.onload = function() {
                window.location.href = '/auth';
            }
            oReq.send();
        }
    </script>
</head>
<body style="background-color: rgb(147, 161, 165);">
    <header style="text-align: right;">
        User: <span id="username"></span>
        <button onclick="logout(logout_url);">
            log out
        </button>
    </header>
    <div id="form-container" style="width: fit-content; height: fit-content; margin: auto;text-align: center; font-weight: 700; font-size: 20px; padding-bottom: 5px;">
            <label for="problem-title">Problem title: </label>
            <br>
            <input type="text" id="problem-title" name="problemtitle" placeholder="Briefly describe your problem..." required>
            <br>
            <br>

            <label for="problem-description">Describe your problem: </label>
            <br>
            <textarea id="problem-description" name="problemdescription" required></textarea>
            <br>
            <br>

            <div id="button-container" style="text-align: center;">
                <button onclick="submitProblem(put_url)">
                    Submit
                </button>
            </div>
            <div id="error-container" style="color: rgb(110, 16, 30); text-align: center; font-size : 16px; font-weight: 400; margin-top: 5px;"></div>
    </div>
    <br>
    <br>
    <div id="unsolved-container">
        <div style="text-align: center; font-weight: 700; font-size: 20px; padding-bottom: 5px;">
            <label for="unsolved" style="margin: auto;">My unsolved problems list</label>
        </div>
        <div id="unsolved-placeholder" style="text-align: center;"></div>
        <table id="unsolved-table">
        </table>
    </div>
    <br>
    <br>
    <br>
    <br>
    <div id="solved-container">
        <div style="text-align: center; font-weight: 700; font-size: 20px; padding-bottom: 5px;">
            <label for="solved" style="margin: auto;">My solved problems list</label>
        </div>
        <div id="solved-placeholder" style="text-align: center;"></div>
        <table id="solved-table">
        </table>
    </div>
</body>
</html>