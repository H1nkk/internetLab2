<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Admin's page</title>
    <script>
        const admin_check_url = "http://localhost:3000/admin_check";
        const logout_url = "http://localhost:3000/logout";
        const get_login_url = "http://localhost:3000/get_login";
        const unassigned_url = "http://localhost:3000/admin/unassigned";
        const unsolved_url = "http://localhost:3000/admin/unsolved";
        const solved_url = "http://localhost:3000/admin/solved";
        const put_url = "http://localhost:3000/admin/put";

        function adminCheck(request, onSuccess) {
            function reqListenerCheck() {
                let data = JSON.parse(this.responseText);
                if (data.status != 'ok') {
                    alert("Only admin can see this page");
                    window.location.href = '/auth';
                } else {
                    onSuccess();
                }
            }

            let oReq = new XMLHttpRequest();
            oReq.addEventListener('load', reqListenerCheck);
            oReq.open("GET", request);
            oReq.send();
        }

        function assignWorker(request, id) {
            function reqListenerWorker() {
                if (this.status === 200) {
                    queryTables();
                } else {
                    console.error('error updating visible tables after assigning');
                }
            }
            let select = document.getElementById(`select_${id}`);

            let oReq = new XMLHttpRequest();
            oReq.addEventListener('load', reqListenerWorker);
            oReq.open('PUT', request);
            oReq.setRequestHeader('Content-Type', 'application/json');
            oReq.send(JSON.stringify({ id : id, worker: select.value }));
        }

        function reqListenerUnassigned() {
            let data = JSON.parse(this.responseText)
            let table_data = data[0];
            let workers_data = data[1];
            console.log(workers_data);
            let table = document.getElementById("unassigned-table");
            table.innerHTML='';
            if (table_data.length > 0) {
                let header = table.createTHead();
                let hrow = header.insertRow();
                for (let k in table_data[0]) {
                    if (k == 'note') continue;
                    if (k == 'responsible_worker') {
                        let cell = hrow.insertCell();
                        cell.outerHTML = '<th>Assign responsible worker</th>';
                    } else {
                        let cell = hrow.insertCell();
                        cell.outerHTML = '<th>' + k.replace("_", " ") + '</th>';
                    }
                }
            } else {
                let placeholder = document.getElementById("unassigned-placeholder");
                placeholder.innerHTML = "No unassigned problems to show";
            }
            for (let i = 0; i < table_data.length; i++) {
                let newRow = table.insertRow();
                for (let j in table_data[i]) {
                    if (j == 'note') continue;
                    let cell = newRow.insertCell();
                    cell.innerHTML = table_data[i][j];
                    if (j == "responsible_worker") {
                        let id = table_data[i]['id'];
                        let inner = `
                            <select id="select_${id}">`;
                        for (let worker_i in workers_data) {
                            let worker = workers_data[worker_i];
                            console.log(worker);
                            inner += `<option value="${worker['login']}">${worker['login']} (${worker['secondname']})</option>`;
                        }

                        inner += `</select>
                        <button onclick="assignWorker('${put_url}', ${id})">Assign to worker</button>
                        `;

                        cell.outerHTML = '<td>' + inner + '</td>';
                    } else if (j == "description") {
                        cell.outerHTML = "<td><pre style='font-family: sans-serif; margin: 0'>" + table_data[i][j] + "</pre></td>";
                    } else {
                        cell.outerHTML = '<td>' + table_data[i][j] + '</td>';
                    }
                }
            }
        }

        function reqListenerUnsolved() {
            let data = JSON.parse(this.responseText);
            let table = document.getElementById("unsolved-table");
            table.innerHTML='';
            if (data.length > 0) {
                let header = table.createTHead();
                let hrow = header.insertRow();
                for (k in data[0]) {
                    if (k == 'note') continue;
                    let cell = hrow.insertCell();
                    cell.outerHTML = '<th>' + k.replace("_", " ") + '</th>';
                }
                let placeholder = document.getElementById("unsolved-placeholder");
                placeholder.innerHTML = "";
            } else {
                let placeholder = document.getElementById("unsolved-placeholder");
                placeholder.innerHTML = "No unsolved problems to show";
            }
            for (let i = 0; i < data.length; i++) {
                let newRow = table.insertRow();
                for (let j in data[i]) {
                    if (j == 'note') continue;
                    let cell = newRow.insertCell();
                    if (j == 'description') {
                        cell.innerHTML = "<pre style='font-family: sans-serif; margin: 0'>" + data[i][j] + "</pre>";
                    } else {
                        cell.innerHTML = data[i][j];
                    }
                }

            }
        }

        function reqListenerSolved() {
            let data = JSON.parse(this.responseText);
            let table = document.getElementById("solved-table");
            table.innerHTML='';
            if (data.length > 0) {
                let header = table.createTHead();
                let hrow = header.insertRow();
                for (let k in data[0]) {
                    let cell = hrow.insertCell();
                    cell.outerHTML = '<th>' + k.replace("_", " ") + '</th>';
                }
                let placeholder = document.getElementById("solved-placeholder");
                placeholder.innerHTML = "";
            } else {
                let placeholder = document.getElementById("solved-placeholder");
                placeholder.innerHTML = "No solved problems to show";
            }
            for (let i = 0; i < data.length; i++) {
                let newRow = table.insertRow();
                for (let j in data[i]) {
                    let cell = newRow.insertCell();
                    if (j == 'description' || j == 'note') {
                        cell.innerHTML = "<pre style='font-family: sans-serif; margin: 0'>" + data[i][j] + "</pre>";
                    } else {
                        cell.innerHTML = data[i][j];
                    }
                }

            }
        }

        function queryTable(request, reqListener) {
            let oReq = new XMLHttpRequest();
            oReq.addEventListener('load', reqListener);
            oReq.open("GET", request);
            oReq.send();
        }

        function queryTables() {
            console.log('query tables');
            queryTable(unassigned_url, reqListenerUnassigned);
            queryTable(unsolved_url, reqListenerUnsolved);
            queryTable(solved_url, reqListenerSolved);
        }

        function setUsername(request) {
            console.log(request);

            function reqListenerUsername() {
                let data = JSON.parse(this.responseText);
                let username_span = document.getElementById("username");
                username_span.innerHTML = data['login'];
            }

            let oReq = new XMLHttpRequest();
            oReq.addEventListener('load', reqListenerUsername);
            oReq.open("GET", request);
            oReq.send();
        }
        
        adminCheck(admin_check_url, function() {
            queryTables();
            setUsername(get_login_url);
        })

        function logout(request) {
            let oReq = new XMLHttpRequest();
            oReq.open("GET", request);
            oReq.onload = function() {
                window.location.href = '/auth';
            }
            oReq.send();
        }
    </script>
</head>
<body style="background-color: rgb(142, 179, 191);">
    <header style="text-align: right;">
        Admin: <span id="username"></span>
        <button onclick="logout(logout_url);">
            log out
        </button>
    </header>
    <div id="unassigned-container">
        <div style="text-align: center; font-weight: 700; font-size: 20px; padding-bottom: 5px;">
            <label for="unassigned-table" style="margin: auto;">Unassigned problems list</label>
        </div>
        <div id="unassigned-placeholder" style="text-align: center;"></div>
        <table id="unassigned-table">
        </table>
    </div>
    <br>
    <br>
    <div id="unsolved-container">
        <div style="text-align: center; font-weight: 700; font-size: 20px; padding-bottom: 5px;">
            <label for="unsolved-table" style="margin: auto;">Unsolved problems list</label>
        </div>
        <div id="unsolved-placeholder" style="text-align: center;"></div>
        <table id="unsolved-table">
        </table>
    </div>
    <br>
    <br>
    <div id="solved-container">
        <div style="text-align: center; font-weight: 700; font-size: 20px; padding-bottom: 5px;">
            <label for="solved-table" style="margin: auto;">Solved problems list</label>
        </div>
        <div id="solved-placeholder" style="text-align: center;"></div>
        <table id="solved-table">
        </table>
    </div>
</body>
</html>